---
title: "Upgrade to new build system"
description: "How to use the new build system preview release"
---

Based on feedback and a steady flow of issues from our previous build system, we're happy to share with you a preview release of our new build system that (hopefully) fixes most of the issues you may have faced.

The main features of the new build sytem are:

- **Bundling by default**: All dependencies are bundled by default, so you no longer need to specify which dependencies to bundle. This solves a whole bunch of issues related to monorepos.
- **Build extensions**: A new way to extend the build process with custom logic. This is a more flexible and powerful way to extend the build process compared to the old system. (including custom esbuild plugin support)
- **Improved configuration**: We've migrated to using [c12](https://github.com/unjs/c12) to power our configuration system.
- **Improved error handling**: We now do a much better job of reporting of any errors that happen during the indexing process by loading your trigger task files dynamically.
- **Improved cold start times**: Previously, we would load all your trigger task files at once, which could lead to long cold start times. Now we load your trigger task files dynamically, which should improve cold start times.

## Update packages

To use the new build system, you have to update to use our preview packages. Update the `@trigger.dev/sdk` package in your package.json:

```json
"@trigger.dev/sdk": "https://pkg.pr.new/triggerdotdev/trigger.dev/@trigger.dev/sdk@1265"
```

You will also need to update your usage of the `trigger.dev` CLI to use the preview release. If you run the CLI via `npx` you can update to the preview release like so:

```sh
# old way
npx trigger.dev@beta dev

# using the preview release
npx https://pkg.pr.new/triggerdotdev/trigger.dev@1265 dev
```

If you've added the `trigger.dev` CLI to your `devDependencies`, then you should update the version to point to the preview release:

```json
"trigger.dev": "https://pkg.pr.new/triggerdotdev/trigger.dev@1265"
```

Once you do that make sure you re-install your dependencies using `npm i` or the equivalent with your preferred package manager.

## Update your `trigger.config.ts`

The new build system does not effect your trigger task files at all, so those can remain unchanged. However, you may need to make changes to your `trigger.config.ts` file.

### `defineConfig`

You should now import the `defineConfig` function from `@trigger.dev/sdk/v3` and export the config as the default export:

```
import { defineConfig } from "@trigger.dev/sdk/v3";

export default defineConfig({
  project: "<project ref>",
});
```

### Deprecated: `dependenciesToBundle`

The new build system will bundle all dependencies by default, so `dependenciesToBundle` no longer makes any sense and can be removed.

#### Externals

Now that all dependencies are bundled, there are some situations where bundling a dependency doesn't work, and needs to be made external (e.g. when a dependency includes a native module). You can now specify these dependencies as build externals in the `defineConfig` function:

```ts
import { defineConfig } from "@trigger.dev/sdk/v3";

export default defineConfig({
  project: "<project ref>",
  build: {
    externals: ["native-module"],
  },
});
```

`externals` is an array of strings, where each string is the name of a dependency that should be made external. Glob expressions are also supported and use the [minimatch](https://github.com/isaacs/minimatch) matcher.

### `additionalFiles`

The `additionalFiles` option has been moved to our new build extension system.

To use build extensions, you'll need to add the `@trigger.dev/build` package to your `devDependencies`:

```sh
npm add https://pkg.pr.new/triggerdotdev/trigger.dev/@trigger.dev/build@1265 -D
```

Now you can import the `additionalFiles` build extension and use it in your `trigger.config.ts` file:

```ts
import { defineConfig } from "@trigger.dev/sdk/v3";
import { additionalFiles } from "@trigger.dev/build/extensions/core";

export default defineConfig({
  project: "<project ref>",
  build: {
    extensions: [
      additionalFiles({ files: ["wrangler/wrangler.toml", "./assets/**", "./fonts/**"] }),
    ],
  },
});
```

### `additionalPackages`

The `additionalPackages` option has been moved to our new build extension system.

To use build extensions, you'll need to add the `@trigger.dev/build` package to your `devDependencies`:

```sh
npm add https://pkg.pr.new/triggerdotdev/trigger.dev/@trigger.dev/build@1265 -D
```

Now you can import the `additionalPackages` build extension and use it in your `trigger.config.ts` file:

```ts
import { defineConfig } from "@trigger.dev/sdk/v3";
import { additionalPackages } from "@trigger.dev/build/extensions/core";

export default defineConfig({
  project: "<project ref>",
  build: {
    extensions: [additionalPackages({ packages: ["wrangler"] })],
  },
});
```

### `resolveEnvVars`

The `resolveEnvVars` export has been moved to our new build extension system.

To use build extensions, you'll need to add the `@trigger.dev/build` package to your `devDependencies`:

```sh
npm add https://pkg.pr.new/triggerdotdev/trigger.dev/@trigger.dev/build@1265 -D
```

Now you can import the `syncEnvVars` build extension and use it in your `trigger.config.ts` file:

```ts
import { defineConfig } from "@trigger.dev/sdk/v3";
import { syncEnvVars } from "@trigger.dev/build/extensions/core";

export default defineConfig({
  project: "<project ref>",
  build: {
    extensions: [
      syncEnvVars(async (params) => {
        return {
          MY_ENV_VAR: "my-value",
        };
      }),
    ],
  },
});
```

The `syncEnvVars` callback function works very similarly to the [`resolveEnvVars`](/deploy-environment-variables#sync-env-vars-from-another-service) callback, but now instead of returning an object with a `variables` key that contains the environment variables, you return an object with the environment variables directly (see the example above).

One other difference is now `params.env` only contains the environment variables that are set in the Trigger.dev environment variables, and not the environment variables from the process. If you want to access the environment variables from the process, you can use `process.env`.

### emitDecoratorMetadata

If you make use of decorators in your code, and have enabled the `emitDecoratorMetadata` tsconfig compiler option, you'll need to enable this in the new build sytem using the `emitDecoratorMetadata` build extension:

```ts
import { defineConfig } from "@trigger.dev/sdk/v3";
import { emitDecoratorMetadata } from "@trigger.dev/build/extensions/typescript";

export default defineConfig({
  project: "<project ref>",
  build: {
    extensions: [emitDecoratorMetadata()],
  },
});
```

### Prisma

We've created a build extension to support using Prisma in your Trigger.dev tasks. To use this extension, you'll need to add the `@trigger.dev/build` package to your `devDependencies`:

```sh
npm add https://pkg.pr.new/triggerdotdev/trigger.dev/@trigger.dev/build@1265 -D
```

Then you can import the `prismaExtension` build extension and use it in your `trigger.config.ts` file, passing in the path to your Prisma schema file:

```ts
import { defineConfig } from "@trigger.dev/sdk/v3";
import { prismaExtension } from "@trigger.dev/build/extensions/prisma";

export default defineConfig({
  project: "<project ref>",
  build: {
    extensions: [
      prismaExtension({
        schema: "prisma/schema.prisma",
      }),
    ],
  },
});
```

This will make sure that your prisma client is generated during the build process when deploying to Trigger.dev.

<Note>
  This does not have any effect when running the `dev` command, so you'll need to make sure you
  generate your client locally first.
</Note>

If you want to also run migrations during the build process, you can pass in the `migrate` option:

```ts
import { defineConfig } from "@trigger.dev/sdk/v3";
import { prismaExtension } from "@trigger.dev/build/extensions/prisma";

export default defineConfig({
  project: "<project ref>",
  build: {
    extensions: [
      prismaExtension({
        schema: "prisma/schema.prisma",
        migrate: true,
        directUrlEnvVarName: "DATABASE_URL_UNPOOLED", // optional - the name of the environment variable that contains the direct database URL if you are using a direct database URL
      }),
    ],
  },
});
```

### audioWaveform

Previously, we installed [Audio Waveform](https://github.com/bbc/audiowaveform) in the build image. That's been moved to a build extension:

```ts
import { defineConfig } from "@trigger.dev/sdk/v3";
import { audioWaveform } from "@trigger.dev/build/extensions/audioWaveform";

export default defineConfig({
  project: "<project ref>",
  build: {
    extensions: [audioWaveform()], // uses verson 1.1.0 of audiowaveform by default
  },
});
```

## Known issues

- Path aliases are not yet support in your `trigger.config.ts` file. To workaround this issue you'll need to rewrite path aliases to their relative paths. (See [this](https://github.com/unjs/jiti/issues/166) and [this](https://knip.dev/reference/known-issues#path-aliases-in-config-files)) for more info.
- Some events in the run trace view may get permanently stuck in a loading state. This is a known issue and we're working on a fix.
