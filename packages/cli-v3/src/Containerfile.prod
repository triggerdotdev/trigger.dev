FROM node:18-alpine@sha256:ca9f6cb0466f9638e59e0c249d335a07c867cd50c429b5c7830dda1bed584649 AS base
ARG TRIGGER_PROJECT_ID
ARG TRIGGER_DEPLOYMENT_ID
ARG TRIGGER_DEPLOYMENT_VERSION

RUN apk add --no-cache dumb-init

FROM base

ENV TRIGGER_PROJECT_ID=${TRIGGER_PROJECT_ID}
ENV TRIGGER_DEPLOYMENT_ID=${TRIGGER_DEPLOYMENT_ID}
ENV TRIGGER_DEPLOYMENT_VERSION=${TRIGGER_DEPLOYMENT_VERSION}

WORKDIR /app

COPY --chown=node:node . .
ENV NODE_ENV=production
RUN npm ci --no-fund --no-audit

USER node

CMD [ "dumb-init", "node", "index.js" ]